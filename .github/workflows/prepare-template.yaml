name: Prepare Template

run-name: Prepare new repository from template

on:
  # Trigger when a new repository is created from this template
  create:

# Ensure this only runs once when the repository is first created
concurrency:
  group: prepare-template
  cancel-in-progress: true

# Minimal permissions required for cleanup and commit
permissions:
  # Give the default GITHUB_TOKEN write permission to commit and push the
  # added or changed files to the repository
  contents: write

jobs:
  prepare-template:
    name: Prepare repository from template

    # Only run on the first workflow run (github.run_number == 1)
    # This ensures the preparation happens exactly once when the repo is created
    if: github.run_number == 1

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Value already defaults to true, but `persist-credentials` is required to push new commits to the repository
          persist-credentials: true

      - name: Make preparation scripts executable
        run: chmod +x "${{ github.workspace }}/scripts/bash/template/"*.sh

      - name: Run template preparation
        run: "${{ github.workspace }}/scripts/bash/template/prepare.sh"
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}

      - name: Verify preparation
        run: |
          echo "Repository structure after preparation:"
          find . -maxdepth 2 -type f -name "*.json" | head -20

      - name: Commit preparation changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: initialize repository from template"
          commit_options: "--no-verify --signoff"
          tag_name: "v0.1.0"
          tagging_message: "Initial release v0.1.0"
          file_pattern: |
            .
          status_options: '--untracked-files=no'
          skip_dirty_check: true
