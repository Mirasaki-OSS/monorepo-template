name: Prepare Template

run-name: Prepare new repository from template

on:
  # Allow manual run in the generated repo (Actions > Prepare Template > Run workflow)
  workflow_dispatch:
  # Run on first push in the generated repo (run_number starts at 1 per repo)
  # Note: This workflow file should be removed after running successfully once
  push:
    branches:
      - main
      - master

# Ensure this only runs once when the repository is first created
concurrency:
  group: prepare-template
  cancel-in-progress: true

# Minimal permissions required for cleanup and commit
permissions:
  # Give the default GITHUB_TOKEN write permission to commit and push the
  # added or changed files to the repository
  contents: write

jobs:
  prepare-template:
    name: Prepare repository from template

    # Only run on the first workflow run (github.run_number == 1)
    # This ensures the preparation happens exactly once when the repo is created
    if: github.run_number == 1

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          # Value already defaults to true, but `persist-credentials` is required to push new commits to the repository
          persist-credentials: true

      # After removing internal packages (/vendor) we need to regenerate the lockfile
      # For this, we will need to setup Node.js and pnpm

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: "pnpm"

      - name: Make preparation scripts executable
        run: chmod +x "${{ github.workspace }}/scripts/bash/template/"*.sh

      - name: Run template preparation
        run: "${{ github.workspace }}/scripts/bash/template/prepare.sh"
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}

      - name: Verify preparation
        run: |
          echo "Repository structure after preparation (depth 2):"
          find . -maxdepth 2 -mindepth 1 \
            -not -path "./.git/*" \
            -not -path "./node_modules/*" \
            -not -path "./.turbo/*" \
            -not -path "./.github/*" \
            | sort | head -80

      - name: Commit preparation changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: initialize repository from template"
          commit_options: "--no-verify --signoff"
          tagging_message: "v0.1.0"
          file_pattern: |
            .
          status_options: '--untracked-files=no'
          skip_dirty_check: true
